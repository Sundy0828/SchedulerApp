
@{
    ViewBag.Title = "Edit Course";
}

<h2>Edit Course</h2>

<hr />


    <div class="row">
        <div class="col-sm-4">
            <div class="row">
                <div class="col-sm-4">
                    <h4>Major</h4>
                    <input id="major" name="major" type="text" class="form-control" value="@ViewBag.course.MCode" placeholder="Enter Major Code" required autofocus maxlength="3" />
                </div>
                <div class="col-sm-4">
                    <h4>Course</h4>
                    <input id="course" name="course" type="text" class="form-control" value="@ViewBag.course.CCode" placeholder="Enter Course Code" required maxlength="3" />
                </div>
                <div class="col-sm-4">
                    <h4>Section</h4>
                    <input id="section" name="section" type="text" class="form-control" value="@ViewBag.course.SCode" placeholder="Enter Section Code" maxlength="2" />
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <h4>Title</h4>
                    <input id="title" name="title" type="text" class="form-control" value="@ViewBag.course.Title" placeholder="Enter Course Title" required />
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <h4>Semester</h4>
                    <select class="form-control" id="semester" name="semester">
                        @foreach (var semester in ViewBag.semester)
                        {
                            if (semester.ID == ViewBag.course.Semester_ID)
                            {
                                <option selected="selected" value="@semester.ID">@semester.Description</option>
                            }
                            else
                            {
                                <option value="@semester.ID">@semester.Description</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <h4>Year</h4>
                    <select class="form-control" id="year" name="year">
                        @foreach (var year in ViewBag.year)
                        {
                            if (year.ID == ViewBag.course.Year_ID)
                            {
                                <option selected="selected" value="@year.ID">@year.Description</option>
                            }
                            else
                            {
                                <option value="@year.ID">@year.Description</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <h4>Liberal Arts Curriculum</h4>
                    <select class="form-control" id="libArt" name="libArt">
                        @foreach (var libArt in ViewBag.libArt)
                        {
                            if (libArt.ID == ViewBag.course.LibArt_ID)
                            {
                                <option selected="selected" value="@libArt.ID">@libArt.Description</option>
                            }
                            else
                            {
                                <option value="@libArt.ID">@libArt.Description</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <h4>Credits</h4>
                    <input id="credits" name="credits" type="number" class="form-control" value="@ViewBag.course.Credits" placeholder="Enter Course Credit Amount" required />
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <br />
                    <button class="btn btn-primary" onclick="save()">
                        <i class="fas fa-save"></i> Save Course
                    </button>
                </div>
            </div>
        </div>

        <div class="col-sm-8">
            <h4>Prerequisites</h4>
            <div class="table-responsive">
                <table id="dataTable" class="table table-striped table-hover">
                    <thead class="bg-dark text-light">
                        <tr>
                            <th>Action</th>
                            <th>Course Code</th>
                            <th>Course Title</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ var count = 0;}
                        @foreach (var course in ViewBag.courses)
                        {
                            var majorCourse = false;
                            var courseCode = course.MCode + " " + course.CCode;
                            if (ViewBag.coursePrerequisites.Contains(courseCode))
                            {
                                majorCourse = true;
                            }
                            <tr>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="customCheck-@count" name="isMajor" checked="@majorCourse">
                                        <label class="custom-control-label" for="customCheck-@count"></label>
                                    </div>
                                </td>
                                <td>@courseCode @course.SCode</td>
                                <td>@course.Title</td>
                            </tr>
                            count++;
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>


@section Scripts {
    <script>
        $(function () {
            var element = document.getElementById("ActiveAdmin");
            element.classList.add("active");
        });

        $(document).ready(function () {
            $('#dataTable').DataTable({
                "order": [],
                "columnDefs": [
                    { "orderable": false, "targets": 0 }
                ]
            });
        });

        function save() {
            var table = $('#dataTable').DataTable();
            var data = table
                .rows()
                .data();
            var id = getUrlParameter("id");
            var rows = table.cells().nodes();
            var checkColumns = $(rows).find('input[type="checkbox"]');

            var values = [];
            var prerequisites = [];

            for (var i = 0; i < data.length; i++) {
                var columnID = parseInt(checkColumns[i].id.substring(12));
                var value = checkColumns[i].checked;
                if (value) {
                    prerequisites.push(data[columnID][1]);
                }
            }

            var major = $('#major').val();
            var course = $('#course').val();
            var section = $('#section').val();
            var title = $('#title').val();
            var semester = $('#semester').find(":selected").val();
            var year = $('#year').find(":selected").val();
            var libArt = $('#libArt').find(":selected").val();
            var credits = $('#credits').val();

            $.ajax({
                url: "/Admin/UpdateCourse",
                data: {
                    "id": id,
                    "major": major,
                    "course": course,
                    "section": section,
                    "title": title,
                    "semester": semester,
                    "year": year,
                    "libArt": libArt,
                    "credits": credits,
                    "prerequisites": prerequisites.join()
                },
                method: "POST",
                async: false,
                success: function () {
                    location.href = "/Admin/Courses";
                    return false;
                },
                error: function () {
                    alert("An error occured");
                }
            });
        }
    </script>
}